<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <style type="text/css" media="screen">
    body, html, div {
      padding: 0px;
      margin: 0px;
      border: 0px;
      background: #888888;
    }
    body, html {
      height: 100%;
      background: black;
      text-align: center;
    }
    div.fullscreen {
      background: black;
      margin-left:auto; margin-right:auto;
    }
    #stylesxml {
      display: none;
    }
  </style>
  <link rel="stylesheet" type="text/css" href="defaultodfstyle.css"/>
  <style id='stylesxmlcss' type="text/css">
/* define namespaces here, because in WebKit they cannot be added dynamically */
@namespace draw url(urn:oasis:names:tc:opendocument:xmlns:drawing:1.0);
@namespace fo url(urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0);
@namespace office url(urn:oasis:names:tc:opendocument:xmlns:office:1.0);
@namespace presentation url(urn:oasis:names:tc:opendocument:xmlns:presentation:1.0);
@namespace style url(urn:oasis:names:tc:opendocument:xmlns:style:1.0);
@namespace svg url(urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0);
@namespace table url(urn:oasis:names:tc:opendocument:xmlns:table:1.0);
@namespace text url(urn:oasis:names:tc:opendocument:xmlns:text:1.0);
  </style>
  <style id='autostylesxmlcss' type="text/css">
/* define namespaces here, because in WebKit they cannot be added dynamically */
@namespace draw url(urn:oasis:names:tc:opendocument:xmlns:drawing:1.0);
@namespace fo url(urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0);
@namespace office url(urn:oasis:names:tc:opendocument:xmlns:office:1.0);
@namespace presentation url(urn:oasis:names:tc:opendocument:xmlns:presentation:1.0);
@namespace style url(urn:oasis:names:tc:opendocument:xmlns:style:1.0);
@namespace svg url(urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0);
@namespace table url(urn:oasis:names:tc:opendocument:xmlns:table:1.0);
@namespace text url(urn:oasis:names:tc:opendocument:xmlns:text:1.0);
  </style>
  <style id='contentxmlcss' type="text/css">
/* define namespaces here, because in WebKit they cannot be added dynamically */
@namespace draw url(urn:oasis:names:tc:opendocument:xmlns:drawing:1.0);
@namespace fo url(urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0);
@namespace office url(urn:oasis:names:tc:opendocument:xmlns:office:1.0);
@namespace presentation url(urn:oasis:names:tc:opendocument:xmlns:presentation:1.0);
@namespace style url(urn:oasis:names:tc:opendocument:xmlns:style:1.0);
@namespace svg url(urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0);
@namespace table url(urn:oasis:names:tc:opendocument:xmlns:table:1.0);
@namespace text url(urn:oasis:names:tc:opendocument:xmlns:text:1.0);
  </style>
  <style id='positioncss' type="text/css">
/* define namespaces here, because in WebKit they cannot be added dynamically */
@namespace draw url(urn:oasis:names:tc:opendocument:xmlns:drawing:1.0);
@namespace svg url(urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0);
@namespace office url(urn:oasis:names:tc:opendocument:xmlns:office:1.0);
office|presentation draw|page { display:none; }
  </style>
  <script src="style2css.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" charset="utf-8">

var xhtmlns = "http://www.w3.org/1999/xhtml";

var dynamicOdfJavascript = null;

function loadJavascript(jsfiles) {
  if (dynamicOdfJavascript) return;
  var req = new XMLHttpRequest();
  var js = "";
  for (var i in jsfiles) {
    req.open('GET', jsfiles[i], null);
    req.send(null);
    js += req.responseText;
  }
  if (js.length ) {
    dynamicOdfJavascript = js;
  }
}

function init() {
  // create a native ODF object
  if (false) { // TODO check if there is a global ODF object
    window.odf = new ODF();
  } else {
    // try to load the javascript required when no native ODF support is
    // available
    // if there is no native window.odf, there still might be a window.qtodf
    var jsfiles;
    if (window.qtodf) {
      jsfiles = ['qtodf.js'];
    } else {
      jsfiles = ['base64.js','bytearray.js','rawinflate.js','zip.js','odf.js'];
    }
    loadJavascript(jsfiles);
    window.odf = eval(dynamicOdfJavascript);
  }

  // if the url has a fragment (#...), try to load the file it represents
  var location = new String(document.location);
  var pos = location.indexOf('#');
  if (pos == -1) {
    return;
  }
  location = location.substr(pos+1);
  // open the odf container
  window.odfcontainer = window.odf.getContainer(location);
  window.odfcontainer.onstatereadychange = refreshOdf;
}

function clear(element) {
  while (element.firstChild) {
    element.removeChild(element.firstChild);
  }
}

function refreshOdf() {

  var OdfContainer = window.odf.OdfContainer;

  if (window.odfcontainer.state != OdfContainer.DONE) {
    return;
  }

  // synchronize the object a window.odfcontainer with the view
  var container = window.odfcontainer;

  clear(document.body);

  var odfnode = container.rootElement;
  document.importNode(odfnode, true);

  handleStyles(odfnode);
  // do content last, because otherwise the document is constantly updated
  // whenever the css changes
  handleContent(container, odfnode);
}

var officens = "urn:oasis:names:tc:opendocument:xmlns:office:1.0";

/**
 * A new content.xml has been loaded. Update the live document with it.
 **/
function handleContent(container, odfnode) {

  var positioncss = document.getElementById('positioncss');
  var css = positioncss.sheet;
  modifyImages(container, odfnode.body, css);
  slidecssindex = css.insertRule(
      'office|presentation draw|page:nth-child(n) { display:block; }',
      css.cssRules.length);  

  // only append the content at the end
  clear(document.body);
  document.body.appendChild(odfnode);
}
function getDirectChild(ns, name, node) {
  node = (node) ?node.firstChild :null;
  while (node) {
    if (node.localName == name && node.namespaceURI == ns) {
      return node;
    }
    node = node.nextSibling;
  }
}
/**
 * A new styles.xml has been loaded. Update the live document with it.
 **/
function handleStyles(odfelement) {
  // update the css translation of the styles  
  var stylesxmlcss = document.getElementById('stylesxmlcss');
  try {
    style2css(stylesxmlcss.sheet, odfelement.styles,
        odfelement.automaticStyles);
  } catch (e) {
    alert(e);
    throw e;
  }
}
  var drawns  = "urn:oasis:names:tc:opendocument:xmlns:drawing:1.0";
  var fons="urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0";
  var svgns   = "urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0";
  var textns  = "urn:oasis:names:tc:opendocument:xmlns:text:1.0";
  var xlinkns = "http://www.w3.org/1999/xlink";

function modifyImages(container, odfbody, stylesheet) {
  var namespaces = {
    draw: drawns,
    fo: fons,
    svg: svgns
  };
  var namespaceResolver = function(prefix) {
    return namespaces[prefix];
  }
  var doc = odfbody.ownerDocument;
  var drawiter = doc.evaluate("*//draw:*"
      + "[@svg:x|@svg:y|@svg:width|@svg:height|@fo:min-height|@fo:min-width]",
      odfbody, namespaceResolver, XPathResult.ANY_TYPE, null);
  var node = drawiter.iterateNext();
  var frames = [];
  while (node) {
    frames[frames.length] = node;
    node = drawiter.iterateNext();
  }  
  for (var i in frames) {
    node = frames[i];
    setFramePosition('frame'+i, node, stylesheet);
  }
  var images = odfbody.getElementsByTagNameNS(drawns, 'image');
  for (var i=0; i<images.length; ++i) {
    setImage('image'+i, container, images.item(i), stylesheet);
  }
}
function setFramePosition(id, frame, stylesheet) {
  frame.setAttribute('styleid', id);
  var rule;
  var anchor = frame.getAttributeNS(textns, 'anchor-type');
  var x = frame.getAttributeNS(svgns, 'x');
  var y = frame.getAttributeNS(svgns, 'y');
  if (anchor == "as-char") {
    rule = 'display: inline-block;';
  } else if (anchor || x || y) {
    rule = 'position: absolute;';
  } else {
    rule = 'display: block;';
  }
  if (x) { rule += 'left: ' + x + ';'; }
  if (y) { rule += 'top: ' + y + ';'; }
  var width = frame.getAttributeNS(svgns, 'width');
  if (width) { rule += 'width: ' + width + ';'; }
  var height = frame.getAttributeNS(svgns, 'height');
  if (height) { rule += 'height: ' + height + ';' }
  var minheight = frame.getAttributeNS(fons, 'min-height');
  if (minheight) { rule += 'min-height: ' + minheight + ';' }
  var minwidth = frame.getAttributeNS(fons, 'min-width'); 
  if (minwidth) { rule += 'min-width: ' + minwidth + ';' }
  rule = 'draw|'+frame.localName+'[styleid="' + id + '"] {' + rule + '}';
  stylesheet.insertRule(rule, stylesheet.cssRules.length);
}
function setImage(id, container, image, stylesheet) {
  image.setAttribute('styleid', id);
  var url = image.getAttributeNS(xlinkns, 'href');
  var callback = function(url) {
    var rule = "background-image: url(" + url + ");";
    rule = 'draw|image[styleid="' + id + '"] {' + rule + '}';
    stylesheet.insertRule(rule, stylesheet.cssRules.length);
  };
  try {
    if (container.getPartUrl) {
      url = container.getPartUrl(url);
      callback(url);
    } else {
      var part = container.getPart(url);
      part.load();
      part.onchange = function(part) {
        callback(part.url);
      };
    }
  } catch (e) {
  }
}
/** temporary function to make a presentation when 'f' is pressed **/
var maxSlideRule = "{display: block;border: 0px;}";
function makePresentation() {
  presentation = true;
  activeSlide -= 1;
  nextSlide();
  var ppi = 98; // larger than 96 to avoid scaling problems
  var pagewidth = 11.02; // inches of hardcoded value
  var pageheight = 8.27; // inches of hardcoded value
  var zoomlevelw = window.innerWidth/ppi/pagewidth;
  var zoomlevelh = window.innerHeight/ppi/pageheight;
  var zoomlevel = (zoomlevelw > zoomlevelh) ?zoomlevelh :zoomlevelw;
  document.body.style.zoom = zoomlevel;
  document.body.style.MozTransform = 'scale('+zoomlevel+')';
}
function unmakePresentation() {
  presentation = false;
  setSlideStyle('n', "{display: block;}");
  var zoomlevel = 1.0;
  document.body.style.zoom = zoomlevel;
  document.body.style.MozTransform = 'scale('+zoomlevel+')';
}
function nextSlide() {
  activeSlide += 1;
  if (activeSlide < 1) activeSlide = 1;
  setSlideStyle(activeSlide, maxSlideRule);
}
function previousSlide() {
  activeSlide -= 2;
  nextSlide();
}
function setSlideStyle(slide, style) {
  var css = document.getElementById('positioncss').sheet;
  var r = css.cssRules;
  css.deleteRule(slidecssindex);
  slidecssindex = css.insertRule('office|presentation draw|page:nth-child('+slide+')'
    + style, css.cssRules.length);
    
  var div = document.getElementById('contentxml');
  if (slide != 'n') {
    div.className = 'fullscreen';
  } else {
    div.className = null;
  }
}
var presentation = false;
var activeSlide = 1;
var slidecssindex = 0;
window.onkeyup = function(e) {
  if (e.keyCode == 70) { // f
    if (presentation) {
      unmakePresentation();
    } else {
      makePresentation();
    }
    return;
  }
  if (!presentation) {
    return;
  }
  if (e.keyCode == 8) { // backspace
    previousSlide();
  } else {
    nextSlide();
  }
}
function fixOdf() {
  var x = new XMLSerializer();
  x = x.serializeToString(document.body.firstChild);
  var parser = new DOMParser();
  var dom = parser.parseFromString(x, "text/xml");
  dom = document.importNode(dom.documentElement, true);
  document.body.removeChild(document.body.firstChild);
  document.body.appendChild(dom);
}
  </script>
  <title></title>
</head>
 
<body onload='init()' >
</body>
</html>
