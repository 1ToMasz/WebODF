<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>JavaScriptZip demo</title>
  <script src="bytearray.js" type="text/javascript" charset="utf-8"></script>
  <script src="zip2.js" type="text/javascript" charset="utf-8"></script>
  <script src="rawinflate.js" type="text/javascript" charset="utf-8"></script>
  <script src="filelist.js" type="text/javascript" charset="utf-8"></script>
  <script src="base64.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" charset="utf-8">

    function showFile(e) {
      e.stopPropagation();
      var ziplist = document.getElementById('ziplist');
      ziplist.innerHTML = '';
      var preview = document.getElementById('preview');
      preview.innerHTML = '';
      var zip;
      try {
        zip = new Zip(e.target, handleLoadedZip);
      } catch (e) {
        ziplist.innerHTML = e;
        throw e;
        return false;
      }
      return false;
    }
    function handleLoadedZip(zip) {
      var ziplist = document.getElementById('ziplist');
      for (var i in zip.entries) {
        if (zip.entries[i].uncompressedSize > 0) {
          ziplist.appendChild(createZipEntry(zip, i));
          ziplist.appendChild(document.createElement('br'));
        }
      }
    }

    function createImageElement(data) {
      var img = document.createElement('img');
      img.src = 'data:;base64,' + Base64.toBase64(data);
      return img;
    }

    function handleEntryData(name, data) {
      var preview = document.getElementById('preview');
      var ext = name.substr(name.length-4);
      if (ext == '.png' || ext == '.jpg' || ext == '.svg') {
        preview.appendChild(createImageElement(data));
      } else {
        preview.innerHTML = data;
      }
    }

    function showEntry(e) {
      e.stopPropagation();
      var preview = document.getElementById('preview');
      preview.innerHTML = 'loading...';

      var name = e.target.zipentry.filename;
      e.target.zip.load(e.target.zipentry.filename, function(data) {
        handleEntryData(name, data);
      });
      return false;
    }

    function createZipEntry(zip, i) {
      var a = document.createElement('a');
      a.zip = zip;
      a.zipentry = a.zip.entries[i];
      a.href = a.zip.uri + '/' + a.zipentry.filename;
      a.appendChild(document.createTextNode(a.zipentry.filename));
      a.onclick = showEntry;
      return a;
    }

    function createFileLink(path) {
      var a = document.createElement('a');
      a.href = path;
      a.appendChild(document.createTextNode(path));
      a.onclick = showFile;
      return a;
    }

    function fillList()
    {
      var body = document.getElementById('list');
      for (var f in fileList) {
        body.appendChild(createFileLink(fileList[f]));
        body.appendChild(document.createElement('br'));
      }
      // emulate click event to simplify debugging
      showFile({target:'kofficetests/odf/134010.ods', stopPropagation:function(){}});
    }
  </script>
</head>
<body id='body' onload="fillList()">
<div id='list'></div>
<div id='ziplist'></div>
<div contenteditable id='preview'></div>
</body>
</html>
